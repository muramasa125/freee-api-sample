<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <title>freee APIの認証サンプル</title>
  <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <div class="form-group col-sm-8" id="content">
      <h2>freee API サンプル</h2>
        <div class="form-group col-xs-2">
          <input class="form-control" id="client_id" placeholder="Client ID" type="text" >
        </div>
        <div class="form-group">
          <input class="form-control col-xs-2" id="client_secret" placeholder="Client Secret" type="text" >
        </div>
        <div class="form-group">
          <input class="form-control" id="redirect_uri" placeholder="Redirect URL" type="text" >
        </div>
        <div class="form-group">
          <button id="auth">認証</button>
        </div>
    </div>
  </div>
  <script>

  $(function() {

    // 初期情報を入力済みかチェック

    if (sessionStorage.getItem('freee_initial')) {
      const save_val = JSON.parse(sessionStorage.getItem('freee_initial'));
      $('#client_id').val(save_val.id);
      $('#client_secret').val(save_val.secret);
      $('#redirect_uri').val(save_val.redirect);
    }

    // 「認証」ボタンを押して認可コード取得=

    $('#auth').on('click', function() {
      getAuthCode();
    });

    // 64桁の認可コードが取得されたらfreee APへ認証リクエストを送る

    if (getParam('code')) {
      if (getParam('code').length == 64) {
        getToken();
      }
    }

    // トークンが取得できていたら「ログインしています」のメッセージを表示

    checkLogin();

    //  「ユーザー名を確認」ボタンをクリックしたらdisplay_nameを表示

    $('#username').on('click', function() {
      showUsername();
    });

    //  「ログアウト」ボタンをクリックしたらトークン類を破棄

    $('#logout').on('click', function() {
      revokeToken();
    });

    // 関数類をまとめて定義

    function checkLogin() {
      if (sessionStorage.getItem('freee_token')) {
        const access_token = JSON.parse(sessionStorage.getItem('freee_token')).access_token
        const mes = `
        <p>ログインしています。</p>
        <button id="username">ユーザー名確認</button><br>
        <button id="logout">トークン破棄</button>
      `
        $("#content").html(mes);
      }
    }

    function getAuthCode() {
      const initial_data = {
        'id': $('#client_id').val(),
        'secret': $('#client_secret').val(),
        'redirect': $('#redirect_uri').val(),
      };
      sessionStorage.setItem('freee_initial', JSON.stringify(initial_data));
      const URL = 'https://accounts.secure.freee.co.jp/public_api/authorize?client_id=' + $('#client_id').val() + '&redirect_uri=' + $('#redirect_uri').val() + '&response_type=code';
      location.href = URL;
    }

    function getToken() {
      const grant_type = 'authorization_code';
      const code = getParam("code");
      $.ajax({
        type: "POST",
        url: "http://127.0.0.1:3000/auth/",
        data: {
          "client_id": $('#client_id').val(),
          "client_secret": $('#client_secret').val(),
          "redirect_uri": $('#redirect_uri').val(),
          "grant_type": "authorization_code",
          "code": getParam("code"),
        }
      }).then((data) => {
        if (data.access_token) {
          console.log(data);
          sessionStorage.setItem('freee_token', JSON.stringify(data));
          location.href = $('#redirect_uri').val();
        }
      });
    }

    function showUsername() {
      const save_token = JSON.parse(sessionStorage.getItem('freee_token'));
      $.ajax({
        type: 'POST',
        url: 'http://127.0.0.1:3000/username/',
        data: {
          'access_token': save_token.access_token,
        },
      }).then((data) => {
        console.log(data);
        $('#content').after('<h2>ユーザー名：' + data.user.display_name + '</h2>');
        $('#content').after('<h2>メールアドレス：' + data.user.email + '</h2>');
      });
    }

    function revokeToken() {
      const revoke_refresh_token = JSON.parse(sessionStorage.getItem('freee_token')).refresh_token;
      $.ajax({
        type: 'POST',
        url: 'http://127.0.0.1:3000/revoke/',
        data: {
          'token': revoke_refresh_token,
        }
      }).then((data) => {
        console.log(data);
        sessionStorage.removeItem('freee_token');
        location.reload();
      });
    }

    function getParam(name, url) {
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, '\\$&');
      let regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }
  });

</script>
</body>
</html>