<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <title>freee APIの認証サンプル</title>
  <!-- Load required Bootstrap and BootstrapVue CSS -->
  <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
  <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css" />
  <!-- Load polyfills to support older browsers -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es2015%2CIntersectionObserver" crossorigin="anonymous"></script>
  <!-- Load Vue followed by BootstrapVue -->
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>
  <!-- axios -->
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
  <div id="app">
    <b-navbar toggleable="lg" type="dark" variant="info">
      <b-navbar-brand href="#">freee API サンプル</b-navbar-brand>
      <!--<b-navbar-nav>
        <b-nav-item-dropdown :text="user.display_name" right>
          <b-dropdown-item href="#">Account</b-dropdown-item>
          <b-dropdown-item v-if="auth.access_token != null" v-on:click="revokeToken()">Log out</b-dropdown-item>
        </b-nav-item-dropdown>
      </b-navbar-nav>-->
    </b-navbar>
    <b-container>
      <h5 v-if="user.id != null">{{ user.email }}:{{ user.display_name }}</h5>
      <b-button variant="warning" v-if="auth.access_token != null" v-on:click="revokeToken()">token破棄</b-button>
      <b-container>
        <p v-if="companies.length > 0">事業所を選択してください</p>
        <b-form-group v-for="company in companies">
          <b-form-radio v-model="company_selected" name="some-radios" :value="company.id">{{ company.display_name }}</b-form-radio>
        </b-form-group>
        <b-button variant="primary" v-if="companies.length > 0" v-on:click="getCompany()">確定</b-button>
        <b-container v-if="myCompany != null">
          <p>事業所情報</p>
          <p>{{ myCompany.display_name }}</p>
          <p>{{ myCompany.zipcode }}</p>
          <p>{{ myCompany.street_name1 }}</p>
          <p>{{ myCompany.street_name2 }}</p>
          <p>{{ myCompany.phone1 }}</p>
          <p>会計期間</p>
          <b-table striped hover :items="myCompany.fiscal_years"></b-table>
        </b-container>
      </b-container>
      <b-button variant="primary" v-if="auth.access_token === null" v-on:click="getAuthCode()">freee認証</b-button>
    </b-container>
  </div>
  <script>
    var app = new Vue({
      el: '#app',
      data: {
        auth: {
          client_id: null,
          client_secret: null,
          redirect_uri: null,
          code: null,
          access_token: null,
          refresh_token: null
        },
        user: {
          id: null,
          email: null,
          display_name: null
        },
        companies: [],
        company_selected: null,
        myCompany: null
      },
      mounted: function () {
        console.log('mounted');
        this.getAuthInfo();
        this.checkLogin();
        this.getLoginUser();
        this.getCompanies();
      },
      methods: {
        getAuthInfo: function () {
          let self = this
          axios.get('/auth')
          .then(function (response) {
            console.log(response);
            self.auth.client_id = response.data.client_id;
            self.auth.client_secret = response.data.client_secret;
            self.auth.redirect_uri = response.data.redirect_uri;
            if (self.getParam('code')) {
              if (self.getParam('code').length === 64) {
                self.getToken();
              }
            }
          })
          .catch(function (error) {
            console.log(error);
          });
        },
        getAuthCode: function () {
          let initial_data = {
            'id': this.auth.client_id,
            'secret': this.auth.client_secret,
            'redirect': this.auth.redirect_uri,
          };
          sessionStorage.setItem('freee_initial', JSON.stringify(initial_data));
          
          let URL = 'https://accounts.secure.freee.co.jp/public_api/authorize?client_id=' + this.auth.client_id + '&redirect_uri=' + this.auth.redirect_uri + '&response_type=code';
          location.href = URL;
        },
        getToken: function () {
          let self = this
          this.auth.code = this.getParam('code');
          axios.post('/auth', {
            client_id: self.auth.client_id,
            client_secret: self.auth.client_secret,
            redirect_uri: self.auth.redirect_uri,
            grant_type: 'authorization_code',
            code: self.auth.code
          })
          .then(function (response) {
            console.log(response);
            self.auth.access_token = response.data.access_token;
            self.auth.refresh_token = response.data.refresh_token;
            sessionStorage.setItem('freee_token', JSON.stringify(response.data));
            location.href = self.auth.redirect_uri
          })
          .catch(function (error) {
            console.log(error);
          })
        },
        checkLogin: function () {
          if (sessionStorage.getItem('freee_token')) {
            this.auth.access_token = JSON.parse(sessionStorage.getItem('freee_token')).access_token
            this.auth.refresh_token = JSON.parse(sessionStorage.getItem('freee_token')).refresh_token
          }
        },
        revokeToken: function () {
          axios.post('/revoke', {
            access_token: this.auth.refresh_token
          })
          .then(function (response) {
            console.log(response);
            sessionStorage.removeItem('freee_token');
            location.reload();
          })
          .catch(function (error) {
            console.log(error);
          });
        },
        getLoginUser: function () {
          let self = this
          axios.get('/user/me', {
            headers: { token: this.auth.access_token },
            data: {}
          })
          .then(function (response) {
            console.log(response);
            self.user.id = response.data.user.id;
            self.user.email = response.data.user.email;
            self.user.display_name = response.data.user.display_name;
          })
          .catch(function () {
            console.log(error);
          })
        },
        getCompanies: function () {
          let self = this
          axios.get('/companies', {
            headers: { token: this.auth.access_token },
            data: {}
          })
          .then(function (response) {
            console.log(response);
            self.companies = response.data.companies;
          })
          .catch(function () {
            console.log(error);
          })
        },
        getCompany: function () {
          let self = this
          axios.get('/company', {
            params: { id: this.company_selected },
            headers: { token: this.auth.access_token },
            data: {}
          })
          .then(function (response) {
            self.myCompany = response.data.company;
            console.log(response);
            self.companies = [];
          })
          .catch(function () {
            console.log(error);
          })
        },
        getParam: function (name, url) {
          if (!url) url = window.location.href;
          name = name.replace(/[\[\]]/g, '\\$&');
          let regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
          if (!results) return null;
          if (!results[2]) return '';
          return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
      }
    })
</script>
</body>
</html>